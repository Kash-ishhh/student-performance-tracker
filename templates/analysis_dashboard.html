{% extends "base.html" %}

{% block title %}Analysis Dashboard{% endblock %}
{% block page_heading %}Student Analytics{% endblock %}

{% block content %}
<div class="row g-4 mt-3">
    
    <div class="col-lg-6">
      <div class="card h-100 p-4 hover-scale">
        <div class="card-header">
          <h5 class="mb-0">Average Scores (%)</h5>
        </div>
        <div class="card-body">
          <div style="position: relative; height: 350px;">
            <canvas id="averageScoresChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-6">
      <div class="card h-100 p-4 hover-scale">
        <div class="card-header">
          <h5 class="mb-0">Attendance (%)</h5>
        </div>
        <div class="card-body">
          <div style="position: relative; height: 350px;">
            <canvas id="attendanceChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-12">
      <div class="card h-100 p-4 hover-scale">
        <div class="card-header">
          <h5 class="mb-0">Attendance vs. Average Score Correlation</h5>
        </div>
        <div class="card-body">
          <div style="position: relative; height: 350px;">
            <canvas id="correlationChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    
  </div>

<script>
    document.addEventListener('DOMContentLoaded', function () {

        // Python API se data fetch karo
        fetch('{{ url_for("get_chart_data") }}') // url_for use kiya
            .then(response => response.json())
            .then(data => {
                
                // Agar koi student nahi hai toh stop
                if (data.labels.length === 0) {
                    console.log("No data available to render charts.");
                    return;
                }

                Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--text-light');
                Chart.defaults.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border-light');

                const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color');
                const secondaryColor = getComputedStyle(document.documentElement).getPropertyValue('--secondary-color');
                const textLight = getComputedStyle(document.documentElement).getPropertyValue('--text-light');
                const borderLight = getComputedStyle(document.documentElement).getPropertyValue('--border-light');


                // === Graph 1: Average Scores (Bar Chart) ===
                const ctxScores = document.getElementById('averageScoresChart').getContext('2d');
                new Chart(ctxScores, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Average Score',
                            data: data.avg_scores,
                            backgroundColor: primaryColor + '90', // Deep Green
                            borderColor: primaryColor,
                            borderWidth: 1,
                            borderRadius: 6,
                            hoverBackgroundColor: primaryColor,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { 
                            y: { beginAtZero: true, max: 100, grid: { color: borderLight }, ticks: { color: textLight } },
                            x: { grid: { display: false }, ticks: { color: textLight } }
                        },
                        plugins: { 
                            legend: { display: false },
                            tooltip: { /* ... (tooltip options) ... */ }
                        }
                    }
                });

                // === Graph 2: Attendance (Bar Chart) ===
                const ctxAttendance = document.getElementById('attendanceChart').getContext('2d');
                new Chart(ctxAttendance, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Attendance',
                            data: data.attendance,
                            backgroundColor: secondaryColor + '80', // Mint Green
                            borderColor: secondaryColor,
                            borderWidth: 1,
                            borderRadius: 6,
                            hoverBackgroundColor: secondaryColor,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { 
                            y: { beginAtZero: true, max: 100, grid: { color: borderLight }, ticks: { color: textLight } },
                            x: { grid: { display: false }, ticks: { color: textLight } }
                        },
                        plugins: { 
                            legend: { display: false },
                            tooltip: { /* ... (tooltip options) ... */ }
                        }
                    }
                });
                
                // === Graph 3: Correlation (Scatter Plot) ===
                const ctxCorrelation = document.getElementById('correlationChart').getContext('2d');
                new Chart(ctxCorrelation, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Student',
                            data: data.scatter_data,
                            backgroundColor: '#EF4444C0', // Red for emphasis
                            borderColor: '#EF4444',
                            pointRadius: 7,
                            hoverRadius: 9,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { 
                                title: { display: true, text: 'Attendance (%)', color: textLight, font: { size: 14 } },
                                beginAtZero: true, max: 100,
                                grid: { color: borderLight },
                                ticks: { color: textLight }
                            },
                            y: { 
                                title: { display: true, text: 'Average Score (%)', color: textLight, font: { size: 14 } },
                                beginAtZero: true, max: 100,
                                grid: { color: borderLight },
                                ticks: { color: textLight }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.raw.label + ': (Att: ' + context.raw.x + '%, Score: ' + context.raw.y + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
                
            })
            .catch(error => console.error('Error fetching chart data:', error));
    });
</script>

{% endblock %}